name: Simple C CI (cmdcalc)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install -y build-essential

      - name: Build cmdcalc
        run: |
          set -e
          if [ -f Makefile ]; then
            make
          else
            gcc src/main.c src/stack.c -o cmdcalc -std=c11 -Wall -Wextra -O2
          fi
          if [ ! -x "./cmdcalc" ]; then
            echo "Error: ./cmdcalc not found or not executable after build."
            ls -la
            exit 1
          fi
          echo "Built ./cmdcalc"

      - name: Smoke test 3+4 -> 7
        run: |
          set -e
          out=$(./cmdcalc "3+4" 2>&1) || { echo "Program failed"; echo "$out"; exit 1; }
          echo "Program output:"
          echo "$out"
          num=$(echo "$out" | grep -o -E '[-+]?[0-9]*\.?[0-9]+' | head -n1 || true)
          if [ -z "$num" ]; then
            echo "No numeric result found"
            exit 1
          fi
          # Compare floats with small tolerance using awk
          expected=7
          awk -v g="$num" -v e="$expected" 'BEGIN{
            g += 0; e += 0;
            diff = g - e; if (diff < 0) diff = -diff;
            if (diff <= 1e-6) { print "PASS: got", g; exit 0 }
            else { print "FAIL: got", g, "expected", e; exit 2 }
          }'
